{% extends "lfs_lab_cert_tracker/base.html" %}

{% block top_menu_nav %}
	{% include "lfs_lab_cert_tracker/subpages/top_menu_nav.html" %}
{% endblock %}

{% block content %}

{% include 'app/subpages/_return_message.html' with data=messages %}

<h3 class="title">
	All Rooms
	<small class="text-secondary">(Total: {{ total_rooms }})</small>
</h3>

<table class="table table-bordered table-striped table-responsive-md text-center table-vertical-middle font-size-sm">
  <thead>
    <tr>
			<th>ID</th>
			<th>Building</th>
			<th>Floor</th>
      <th>Room <br /> Number</th>
			<th>PIs</th>
      <th>Areas</th>
			<th>Required Trainings</th>
			<th style="width: 100px;">Actions</th>
    </tr>
  </thead>
  <tbody>
		{% for room in rooms %}
      <tr>
        <td>{{ room.id }}</td>
				<td>{{ room.building.code }}</td>
				<td>{{ room.floor.name }}</td>
        <td>{{ room.number }}</td>
				<td class="text-left">
					<ul class="ml-minus-20">
						{% for manager in room.managers.all %}
	            <li>{{ manager.get_full_name }}</li>
	          {% endfor %}
					</ul>
				</td>
        <td>
          {% for area in room.areas.all %}
            <a class="d-block" href="{% url 'app:area_details' area_id=area.id %}?t=users_in_area">{{ area.name }}</a>
          {% endfor %}
        </td>
				<td class="text-left">
					<ul class="ml-minus-20">
					{% for training in room.trainings.all %}
						<li>{{ training.name }}</li>
					{% endfor %}
					</ul>
				</td>
        <td>
					<button class="btn btn-outline-primary btn-xs width-100p mb-2" type="button" data-toggle="modal" data-target="#room-managers-change-modal-{{ room.id }}">PIs</button>
					<div class="modal fade" id="room-managers-change-modal-{{ room.id }}" tabindex="-1" role="dialog" aria-labelledby="room-managers-change-modal-label-{{ room.id }}" aria-hidden="true">
						<div class="modal-dialog modal-lg" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title text-info" id="room-managers-change-modal-label-{{ room.id }}">Change Room's PIs</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
								</div>
								<div class="modal-body text-left">
									<div class="modal-item">
										<form action="{% url 'key_request:change_room_managers' %}" method="post">
											{% csrf_token %}

											<table
												class="table table-bordered table-responsive-md"
												data-toggle="table"
												data-classes=""
												data-pagination="true"
												data-search="true"
												data-page-size="10"
												data-page-list="[10, 20, 30, 50, 100, all]"
											>
												<thead>
													<tr>
														<th>Last Name</th>
														<th>First Name</th>
														<th>CWL</th>
														<th>Select</th>
													</tr>
												</thead>
												<tbody>
													{% for user in users %}
														<tr>
															<td>{{ user.last_name }}</td>
															<td>{{ user.first_name }}</td>
															<td>{{ user.username }}</td>
															<td>
																<input type="checkbox" name="manager[]" value="{{ user.id }}" {% if user.id in room.manager_ids %}checked{% endif %} />
															</td>
														</tr>
													{% endfor %}
												</tbody>
											</table>

											<input type="hidden" name="room" value="{{ room.id }}" />
											<input class="btn btn-warning d-block mx-auto" type="submit" value="Change" />
										</form>
									</div>
								</div>
							</div>
						</div>
					</div>

					<button class="btn btn-outline-primary btn-xs width-100p mb-2" type="button" data-toggle="modal" data-target="#room-areas-change-modal-{{ room.id }}">Areas</button>
					<div class="modal fade" id="room-areas-change-modal-{{ room.id }}" tabindex="-1" role="dialog" aria-labelledby="room-areas-change-modal-label-{{ room.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title text-info" id="room-areas-change-modal-label-{{ room.id }}">Change Room's Areas</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body text-left">
                  <div class="modal-item">
                    <form action="{% url 'key_request:change_room_areas' %}" method="post">
                      {% csrf_token %}

                      <table
												class="table table-bordered table-responsive-md"
												data-toggle="table"
												data-classes=""
												data-pagination="true"
												data-search="true"
												data-page-size="10"
												data-page-list="[10, 20, 30, 50, 100, all]"
											>
                        <thead>
                          <tr>
                            <th>Area</th>
                            <th>Select</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for area in areas %}
                            <tr>
                              <td>{{ area.name }}</td>
                              <td>
                                <input type="checkbox" name="area[]" value="{{ area.id }}" {% if area.id in room.area_ids %}checked{% endif %} />
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>

                      <input type="hidden" name="room" value="{{ room.id }}" />
                      <input class="btn btn-warning d-block mx-auto" type="submit" value="Change" />
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

					<button class="btn btn-outline-primary btn-xs width-100p mb-2" type="button" data-toggle="modal" data-target="#room-trainings-change-modal-{{ room.id }}">Trainings</button>
					<div class="modal fade" id="room-trainings-change-modal-{{ room.id }}" tabindex="-1" role="dialog" aria-labelledby="room-trainings-change-modal-label-{{ room.id }}" aria-hidden="true">
						<div class="modal-dialog modal-lg" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title text-info" id="room-trainings-change-modal-label-{{ room.id }}">Change Room's Trainings</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
								</div>
								<div class="modal-body text-left">
									<div class="modal-item">
										<form action="{% url 'key_request:change_room_trainings' %}" method="post">
											{% csrf_token %}

											<table
												class="table table-bordered table-responsive-md"
												data-toggle="table"
												data-classes=""
												data-pagination="true"
												data-search="true"
												data-page-size="10"
												data-page-list="[10, 20, 30, 50, 100, all]"
											>
												<thead>
													<tr>
														<th>Training</th>
														<th>Select</th>
													</tr>
												</thead>
												<tbody>
													{% for training in trainings %}
														<tr>
															<td>{{ training.name }}</td>
															<td>
																<input type="checkbox" name="training[]" value="{{ training.id }}" {% if training.id in room.training_ids %}checked{% endif %} />
															</td>
														</tr>
													{% endfor %}
												</tbody>
											</table>

											<input type="hidden" name="room" value="{{ room.id }}" />
											<input class="btn btn-warning d-block mx-auto" type="submit" value="Change" />
										</form>
									</div>
								</div>
							</div>
						</div>
					</div>

          <button class="btn btn-warning btn-xs width-100p mb-2" type="button" data-toggle="modal" data-target="#room-number-edit-modal-{{ room.id }}">Edit</button>
          <div class="modal fade" id="room-number-edit-modal-{{ room.id }}" tabindex="-1" role="dialog" aria-labelledby="room-number-edit-modal-label-{{ room.id }}" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title text-info" id="room-number-edit-modal-label-{{ room.id }}">Edit Room</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body text-left">
                  <div class="modal-item">
                    <form action="{% url 'key_request:edit_room' %}" method="post">
                      {% csrf_token %}

											<div class="mb-3">
												<label for="id_building_{{ room.id }}" class="font-weight-bold">Building:</label>
												<select name="building" class="form-control" id="id_building_{{ room.id }}">
												  <option value="" selected="">---------</option>
												  <option value="2">FNH</option>
												  <option value="1">MCML</option>
												</select>
											</div>

                      <div class="mb-3">
                        <label for="id_number_{{ room.id }}" class="font-weight-bold">
                          Name:
                          <span class="material-symbols-outlined">emergency</span>
                        </label>
                        <input id="id_number_{{ room.id }}" class="form-control" type="text" name="number" value="{{ room.number }}" maxlength="10" required />
                        <small class="text-muted">It must be unique. Maximum characters: 10</small>
                      </div>

                      <input type="hidden" name="room" value="{{ room.id }}" />
                      <input class="btn btn-warning d-block mx-auto" type="submit" value="Update" />
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <form class="list-form width-100p" action="{% url 'key_request:delete_room' %}" method="post" onsubmit="return confirm('Are you sure to delete this room - {{ room.number }}?');">
            {% csrf_token %}

            <input type="hidden" name="room" value="{{ room.id }}"  />
            <input class="btn btn-danger btn-xs width-100p" type="submit" value="Delete" />
          </form>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="100%">No rooms found</td>
      </tr>
    {% endfor %}
  </tbody>
</table>


{% if request.user.is_superuser %}

	<div class="row">
		<div class="col-md-8">
			<h4 class="text-info mt-5 mb-3">Create Room</h4>

			<form action="" method="POST">
				{% csrf_token %}

				<nav class="mt-5">
				  <div class="nav nav-tabs" id="nav-tab" role="tablist">
						<button class="nav-link active" id="nav-number-tab" data-toggle="tab" data-target="#nav-number" type="button" role="tab" aria-controls="nav-number" aria-selected="true">Basic Info</button>
				    <button class="nav-link" id="nav-pis-tab" data-toggle="tab" data-target="#nav-pis" type="button" role="tab" aria-controls="nav-pis" aria-selected="true">PIs</button>
				    <button class="nav-link" id="nav-areas-tab" data-toggle="tab" data-target="#nav-areas" type="button" role="tab" aria-controls="nav-areas" aria-selected="false">Areas</button>
				    <button class="nav-link" id="nav-trainings-tab" data-toggle="tab" data-target="#nav-trainings" type="button" role="tab" aria-controls="nav-trainings" aria-selected="false">Required Trainings</button>
				  </div>
				</nav>

				<div class="tab-content" id="nav-tabContent">

					<div class="tab-pane fade show active pt-5" id="nav-number" role="tabpanel" aria-labelledby="nav-number-tab">
						<table class="form-table">
							{% for field in form.visible_fields %}
								<tr>
									<th>
										<label for="{{ field.id_for_label }}">
											{{ field.label }}
											{% if field.name == 'number' %}
												{% include 'lfs_lab_cert_tracker/icons/asterisk.html' %}
											{% endif %}
										</label>
									</th>
									<td>
										{{ field }}
										{% if field.help_text %}
											<div class="helptext">{{ field.help_text|safe }}</div>
										{% endif %}
									</td>
								</tr>
							{% endfor %}
						</table>
					</div>

				  <div class="tab-pane fade pt-4" id="nav-pis" role="tabpanel" aria-labelledby="nav-pis-tab">
						<table
							class="table table-bordered table-striped table-responsive-md"
							data-toggle="table"
							data-sortable="true"
							data-classes=""
							data-pagination="true"
							data-search="true"
							data-page-size="10"
							data-page-list="[10, 20, 30, 50, 100, all]"
						>
		          <thead>
		            <tr>
		              <th data-sortable="true">Last Name</th>
									<th data-sortable="true">First Name</th>
									<th data-sortable="true">CWL</th>
		              <th>Select</th>
		            </tr>
		          </thead>
		          <tbody>
		            {% for user in users %}
		              <tr>
		                <td>{{ user.last_name }}</td>
										<td>{{ user.first_name }}</td>
										<td>{{ user.username }}</td>
		                <td>
		                  <input type="checkbox" name="manager[]" value="{{ user.id }}" />
		                </td>
		              </tr>
		            {% endfor %}
		          </tbody>
		        </table>
					</div>

				  <div class="tab-pane fade pt-4" id="nav-areas" role="tabpanel" aria-labelledby="nav-areas-tab">
						<table
							class="table table-bordered table-striped table-responsive-md"
							data-toggle="table"
							data-classes=""
							data-pagination="true"
							data-search="true"
							data-page-size="10"
							data-page-list="[10, 20, 30, 50, 100, all]"
						>
		          <thead>
		            <tr>
		              <th>Area Name</th>
		              <th>Select</th>
		            </tr>
		          </thead>
		          <tbody>
		            {% for area in areas %}
		              <tr>
		                <td class="text-left">{{ area.name }}</td>
		                <td>
		                  <input type="checkbox" name="area[]" value="{{ area.id }}" />
		                </td>
		              </tr>
		            {% endfor %}
		          </tbody>
		        </table>
					</div>

				  <div class="tab-pane fade pt-4" id="nav-trainings" role="tabpanel" aria-labelledby="nav-trainings-tab">
						<table
							class="table table-bordered table-striped table-responsive-md"
							data-toggle="table"
							data-classes=""
							data-pagination="true"
							data-search="true"
							data-page-size="10"
							data-page-list="[10, 20, 30, 50, 100, all]"
						>
		          <thead>
		            <tr>
		              <th>Training Name</th>
		              <th>Select</th>
		            </tr>
		          </thead>
		          <tbody>
		            {% for training in trainings %}
		              <tr>
		                <td class="text-left">{{ training.name }}</td>
		                <td>
		                  <input type="checkbox" name="training[]" value="{{ training.id }}" />
		                </td>
		              </tr>
		            {% endfor %}
		          </tbody>
		        </table>
					</div>
				</div>
				<input class="btn btn-primary mt-3" type="submit" value="Create New Room" />
			</form>
		</div>
	</div>

{% endif %}

{% endblock %}


{% block js %}

<script type="text/javascript">

</script>

{% endblock %}
