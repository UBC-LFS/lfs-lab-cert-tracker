{% extends "header.html" %}

{% block content %}

{% if messages %}
	{% for message in messages %}
		<div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
			{{ message }}
			<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			</button>
		</div>
	{% endfor %}
{% endif %}


<nav class="mb-4">
  <div class="nav nav-tabs">
    <a class="nav-item nav-link {% if current_tab == 'all' %} active {% endif %}" href="{% url 'users' %}?t=all">
      All Users
    </a>
    <a class="nav-item nav-link {% if current_tab == 'report' %} active {% endif %}" href="{% url 'users' %}?t=report">
      User Report
    </a>
    <a class="nav-item nav-link {% if current_tab == 'create' %} active {% endif %}" href="{% url 'users' %}?t=create">
      Create User
    </a>
  </div>
</nav>

{% if current_tab == 'report' %}

	<h3 class="my-5">
		User Report <small class="text-secondary">Total: {{ users_in_missing_training|length }}</small>
	</h3>

	<div class="text-primary float-right">
		<i class="material-icons">cloud_download</i>
		<a href="{% url 'users_in_missing_training_report' %}" target="_blank">Download as PDF</a>
	</div>

	<table class="table table-bordered table-striped table-hover table-responsive-md text-center font-size-sm">
		<thead>
			<tr>
				<th>ID</th>
				<th>Full Name</th>
				<th>CWL</th>
				<th>Number of <br />Missing Trainings</th>
				<th>Missing Training Records</th>
			</tr>
		</thead>
		<tbody>
			{% for user in users %}
				<tr>
					<td>{{ user.id }}</td>
					<td>{{ user.get_full_name }}</td>
					<td>{{ user.username }}</td>
					<td>{{ user.missing_certs.count }}</td>
					<td class="text-left">
						<ul>
							{% for training in user.missing_certs %}
								<li>{{ training.cert }}</li>
							{% endfor %}
						</ul>
					</td>
				</tr>
			{% empty %}
				No users found
			{% endfor %}
		</tbody>
	</table>

	{% include 'lfs_lab_cert_tracker/_pagination.html' with data=users %}

{% elif current_tab == 'create' %}

	<h3 class="my-5">New Users</h3>

	<form action="" method="post">
		{% csrf_token %}

		<table>{{ user_form.as_table }}</table>
		<input class="btn btn-primary mt-3" type="submit" value="Create User" />
	</form>

{% else %}

	<h3 class="my-5">All Users <small class="text-secondary">Total: {{ total_users }}</small></h3>

	<div class="search-field">
		<form method="GET">
			<div class="input-field">
				<input class="search-field-text" type="text" name="q" value="{{ request.GET.q }}" placeholder="Search by CWL and Name">
				<button class="btn btn-light btn-sm" type="submit" name="action">Search</button>
			</div>
		</form>
	</div>

	<table class="table table-bordered table-striped table-hover table-responsive-md text-center font-size-sm">
	  <thead>
	    <tr>
	      <th>CWL</th>
	      <th>First <br />Name</th>
				<th>Last <br />Name</th>
				<th>E-mail</th>
				<th>Missing <br />Training <br />Record</th>
				<th>Admin</th>
				<th>Inactivated <br />Date</th>
				<th>Actions</th>
	    </tr>
	  </thead>
	  <tbody>
	    {% for user in users %}
	      <tr>
	        <td>
						<a href="/users/{{user.id}}">{{ user.username }}</a>
					</td>
	        <td>{{ user.first_name }}</td>
	        <td>{{ user.last_name }}</td>
					<td>{{ user.email }}</td>
					<td>
						{% if user.missing_certs|length == 0 %}
							<span class="badge badge-light">NO</span>
						{% else %}
							<span class="badge badge-warning">YES ({{ user.missing_certs|length }})</span>
						{% endif %}
					</td>
					<td>
						{% if user.is_superuser %}
							<i class="material-icons text-primary">done</i>
						{% endif %}
					</td>
					<td>
						{% if not user.is_active and user.inactive %}
							{{ user.inactive.inactive_date }}
						{% endif %}
					</td>
					<td>
						<div class="btn-toolbar">
							<form class="list-form" action="{% url 'switch_admin' %}" method="post" onsubmit="return confirm('Are you sure to {% if user.is_superuser %} REVOKE administrator privileges of {% else %} GRANT administrator privileges to {% endif %} this user - {{user.username}} ?');">
			 					{% csrf_token %}

			 					<input type="hidden" name="user" value="{{ user.id }}" />
								<input class="btn btn-info btn-xs" type="submit" value="{% if user.is_superuser %} Revoke Admin {% else %} Grant Admin {% endif %}"/>
							</form>

							<form class="list-form" action="{% url 'switch_inactive' %}" method="post" onsubmit="return confirm('Are you sure to switch this user - {{user.username}} {% if not user.is_active and user.inactive_date %} from INACTIVE to ACTIVE {% else %} from ACTIVE to INACTIVE {% endif %} ?');">
								{% csrf_token %}

								<input type="hidden" name="user" value="{{ user.id }}" />

								{% if not user.is_active and user.inactive %}
									<input class="btn btn-inactive btn-xs mx-2" type="submit" value="Inactive" />
								{% else %}
									<input class="btn btn-success btn-xs mx-2" type="submit" value="Active" />
								{% endif %}
							</form>

							<form class="list-form" action="{% url 'delete_user' %}" method="post" onsubmit="return confirm('Are you sure to delete this user - {{user.username}}?');">
								{% csrf_token %}

								<input type="hidden" name="user" value="{{ user.id }}" />
								<input class="btn btn-danger btn-xs" type="submit" value="Delete" />
			 				</form>
						</div>
					</td>
	      </tr>
	    {% endfor %}
	  </tbody>
	</table>

	{% include 'lfs_lab_cert_tracker/_pagination.html' with data=users %}

{% endif %}


{% endblock %}
