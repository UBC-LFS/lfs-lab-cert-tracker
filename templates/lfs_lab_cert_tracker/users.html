{% extends "header.html" %}

{% block content %}

<nav class="mb-4">
  <div class="nav nav-tabs">
    <a class="nav-item nav-link {% if current_tab == 'all' %} active {% endif %}" href="{% url 'users' %}?t=all">
      All Users
    </a>
    <a class="nav-item nav-link {% if current_tab == 'report' %} active {% endif %}" href="{% url 'users' %}?t=report">
      User Report
    </a>
    <a class="nav-item nav-link {% if current_tab == 'new' %} active {% endif %}" href="{% url 'users' %}?t=new">
      New Users
    </a>
  </div>
</nav>

{% include 'lfs_lab_cert_tracker/sub_templates/_return_message.html' with data=messages %}

{% if current_tab == 'report' %}

	<h3 class="my-5">
		User Report <small class="text-secondary">Total: {{ users_in_missing_training|length }}</small>
	</h3>

	<div class="text-primary float-right">
		<i class="material-icons">cloud_download</i>
		<a href="{% url 'users_in_missing_training_report' %}" target="_blank">Download as PDF</a>
	</div>

	<table class="table table-bordered table-striped table-hover table-responsive-md text-center font-size-sm">
		<thead>
			<tr>
				<th>ID</th>
				<th>Full Name</th>
				<th>CWL</th>
				<th>Number of <br />Missing Trainings</th>
				<th>Missing Training Records</th>
			</tr>
		</thead>
		<tbody>
			{% for user in users %}
				<tr>
					<td>{{ user.id }}</td>
					<td>{{ user.get_full_name }}</td>
					<td>{{ user.username }}</td>
					<td>{{ user.missing_certs.count }}</td>
					<td class="text-left">
						<ul>
							{% for training in user.missing_certs %}
								<li>{{ training.cert }}</li>
							{% endfor %}
						</ul>
					</td>
				</tr>
			{% empty %}
				No users found
			{% endfor %}
		</tbody>
	</table>

	{% include 'lfs_lab_cert_tracker/sub_templates/_pagination.html' with data=users %}

{% elif current_tab == 'new' %}

  <div class="row">
    <div class="new-users-section col-md-6 offset-md-3">
      <h3 class="">New Users</h3>

      {% include 'lfs_lab_cert_tracker/sub_templates/_user_form_note.html' %}

    	<form action="" method="post">
    		{% csrf_token %}

        {% for field in user_form.visible_fields  %}
          <div class="field-wrapper">
            <label for="{{ field.id_for_label }}">
              {{ field.label }}: <span class="text-danger">*</span>
            </label>

            {% if field.help_text %}
              <div class="help">{{ field.help_text|safe }}</div>
            {% endif %}
            {{ field }}
          </div>
        {% endfor %}

    		<input class="btn btn-primary mt-3" type="submit" value="Create User" />
    	</form>
    </div>
  </div>

{% else %}

	<h3 class="my-5">All Users <small class="text-secondary">Total: {{ total_users }}</small></h3>

	<div class="search-field">
		<form method="GET">
			<div class="input-field">
				<input type="hidden" name="t" value="all" />
				<input class="search-field-text" type="text" name="q" value="{{ request.GET.q }}" placeholder="Search by CWL and Name">
				<button class="btn btn-secondary btn-sm" type="submit">Search</button>
				<a class="btn btn-sm btn-light" href="{% url 'users' %}?t=all">Clear</a>
			</div>
		</form>
	</div>

	<table class="table table-bordered table-striped table-hover table-responsive-md text-center font-size-sm">
	  <thead>
	    <tr>
	      <th>CWL</th>
	      <th>First <br />Name</th>
				<th>Last <br />Name</th>
				<th>E-mail</th>
				<th>Missing <br />Training <br />Record</th>
				<th>Admin</th>
				<th>Inactivated <br />Date</th>
				<th>Actions</th>
	    </tr>
	  </thead>
	  <tbody>
	    {% for user in users %}
	      <tr>
	        <td>
						<a href="/users/{{user.id}}">{{ user.username }}</a>
					</td>
	        <td>{{ user.first_name }}</td>
	        <td>{{ user.last_name }}</td>
					<td>{{ user.email }}</td>
					<td>
						{% if user.missing_certs|length == 0 %}
							<span class="badge badge-light">NO</span>
						{% else %}
							<span class="badge badge-warning">YES ({{ user.missing_certs|length }})</span>
						{% endif %}
					</td>
					<td>
						{% if user.is_superuser %}
							<i class="material-icons text-primary">done</i>
						{% endif %}
					</td>
					<td>
						{% if not user.is_active and user.inactive %}
							{{ user.inactive.inactive_date }}
						{% endif %}
					</td>
					<td>
						<div class="btn-toolbar">

              <button type="button" class="btn btn-primary btn-xs mr-2" data-toggle="modal" data-target="#user-edit-modal-{{ user.id }}">Edit</button>

              <div id="user-edit-modal-{{ user.id }}" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="user-edit-modal-{{ user.id }}-label" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title text-info" id="user-edit-modal-{{ user.id }}-label">Edit User</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body text-left p-4">
                      <h4>{{ user.get_full_name }}</h4>
                      <h5 class="text-secondary">CWL: {{ user.username }}</h5>

                      {% include 'lfs_lab_cert_tracker/sub_templates/_user_form_note.html' %}

                      <form action="{% url 'edit_user' %}" method="post">
                        {% csrf_token %}

                        <div class="field-wrapper">
                          <label for="id_username_{{ user.id }}">
                            CWL: <span class="text-danger">*</span>
                          </label>
                          <div class="help">Unique. Maximum 150 characters allowed</div>
                          <input id="id_username_{{ user.id }}" type="text" name="username" class="form-control" required maxlength="150" placeholder="Enter"
                            {% if user.username %}
                              value="{{ user.username }}"
                            {% else %}
                              value=""
                            {% endif %}
                          />
                        </div>

                        <div class="field-wrapper">
                          <label for="id_first_name_{{ user.id }}">
                            First Name: <span class="text-danger">*</span>
                          </label>
                          <div class="help">Maximum 30 characters allowed</div>
                          <input id="id_first_name_{{ user.id }}" type="text" name="first_name" class="form-control" required maxlength="30" placeholder="Enter"
                            {% if user.first_name %}
                              value="{{ user.first_name }}"
                            {% else %}
                              value=""
                            {% endif %}
                          />
                        </div>

                        <div class="field-wrapper">
                          <label for="id_last_name_{{ user.id }}">
                            Last Name: <span class="text-danger">*</span>
                          </label>
                          <div class="help">Maximum 150 characters allowed</div>
                          <input id="id_last_name_{{ user.id }}" type="text" name="last_name" class="form-control" required maxlength="150" placeholder="Enter"
                            {% if user.last_name %}
                              value="{{ user.last_name }}"
                            {% else %}
                              value=""
                            {% endif %}
                          />
                        </div>

                        <div class="field-wrapper">
                          <label for="id_email_{{ user.id }}">
                            Email: <span class="text-danger">*</span>
                          </label>
                          <div class="help">Maximum 254 characters allowed</div>
                          <input id="id_email_{{ user.id }}" type="text" name="email" class="form-control" required maxlength="254" placeholder="Enter"
                            {% if user.email %}
                              value="{{ user.email }}"
                            {% else %}
                              value=""
                            {% endif %}
                          />
                        </div>

        			 					<input type="hidden" name="user" value="{{ user.id }}" />
        								<input type="hidden" name="next" value="{{ request.get_full_path }}" />
                        <input class="btn btn-primary" type="submit" value="Update" />
                      </form>
                    </div>
                  </div>
                </div>
              </div>

							<form class="list-form" action="{% url 'switch_admin' %}" method="post" onsubmit="return confirm('Are you sure to {% if user.is_superuser %} REVOKE administrator privileges of {% else %} GRANT administrator privileges to {% endif %} this user - {{user.username}} ?');">
			 					{% csrf_token %}

			 					<input type="hidden" name="user" value="{{ user.id }}" />
								<input type="hidden" name="next" value="{{ request.get_full_path }}" />
								<input class="btn btn-info btn-xs" type="submit" value="{% if user.is_superuser %} Revoke Admin {% else %} Grant Admin {% endif %}"/>
							</form>

							<form class="list-form" action="{% url 'switch_inactive' %}" method="post" onsubmit="return confirm('Are you sure to switch this user - {{user.username}} {% if not user.is_active and user.inactive_date %} from INACTIVE to ACTIVE {% else %} from ACTIVE to INACTIVE {% endif %} ?');">
								{% csrf_token %}

								<input type="hidden" name="user" value="{{ user.id }}" />
								<input type="hidden" name="next" value="{{ request.get_full_path }}" />

								{% if not user.is_active and user.inactive %}
									<input class="btn btn-inactive btn-xs mx-2" type="submit" value="Inactive" />
								{% else %}
									<input class="btn btn-success btn-xs mx-2" type="submit" value="Active" />
								{% endif %}
							</form>

							<form class="list-form" action="{% url 'delete_user' %}" method="post" onsubmit="return confirm('Are you sure to delete this user - {{user.username}}?');">
								{% csrf_token %}

								<input type="hidden" name="user" value="{{ user.id }}" />
								<input type="hidden" name="next" value="{{ request.get_full_path }}" />
								<input class="btn btn-danger btn-xs" type="submit" value="Delete" />
			 				</form>
						</div>
					</td>
	      </tr>
	    {% endfor %}
	  </tbody>
	</table>

	{% include 'lfs_lab_cert_tracker/sub_templates/_pagination.html' with data=users %}

{% endif %}


{% endblock %}
